<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Analytics</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    .chart-container {
      position: relative;
      margin-bottom: 2rem;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 1rem;
      background-color: #fff;
    }
    .chart-toolbar {
      text-align: right;
      margin-bottom: 10px;
    }
    .fullscreen {
      position: fixed !important;
      top: 0;
      left: 0;
      width: 100% !important;
      height: 100% !important;
      z-index: 9999;
      background: white;
      padding: 2rem;
      overflow: auto;
    }
    .bg-purple {
      background-color: purple !important;
    }
    canvas {
      max-width: 100%;
    }
    .rotate-labels .chartjs-render-monitor {
      transform: rotate(45deg);
      text-anchor: start;
    }
  </style>
</head>

<body class="container py-4">
  <h2 class="mb-4">Data Analytics</h2>

  <div class="mb-4">
    <h5>Total FelderhoffSNP_ID Progress: <span id="snpTotal" class="text-muted"></span></h5>
    <div class="progress">
      <div id="snpProgress" class="progress-bar bg-purple" role="progressbar" style="width: 0%">0%</div>
    </div>
  </div>

  <div id="charts"></div>

  <script>
    const csvUrl = '/data/lab-intertek-markers.csv';

    function createChartSection(id, title) {
      return `
        <div class="chart-container" id="container-${id}">
          <div class="chart-toolbar">
            <button onclick="toggleFullscreen('${id}')" class="btn btn-sm btn-outline-secondary">Maximize</button>
            <button onclick="exportChart('${id}')" class="btn btn-sm btn-outline-primary">Export</button>
          </div>
          <h5>${title}</h5>
          <canvas id="${id}"></canvas>
        </div>
      `;
    }

    function toggleFullscreen(id) {
      const el = document.getElementById(`container-${id}`);
      el.classList.toggle("fullscreen");
    }

    function exportChart(id) {
      const canvas = document.getElementById(id);
      html2canvas(canvas).then(canvasExport => {
        canvasExport.toBlob(blob => {
          saveAs(blob, `${id}.png`);
        });
      });
    }

    document.addEventListener('DOMContentLoaded', function () {
      fetch(csvUrl)
        .then(res => res.text())
        .then(data => {
          const rows = data.trim().split('\n').map(row => row.split(','));
          const headers = rows.shift();

          const famIndex = headers.indexOf("FAM_SNIP");
          const hexIndex = headers.indexOf("HEX_SNIP");
          const alleleIndex = headers.indexOf("Allele/Locus");
          const feldIndex = headers.indexOf("FelderhoffSNP_ID");
          const interIndex = headers.indexOf("Intermarker_ID");

          const famCounts = {};
          const hexCounts = {};
          const alleleCounts = {};
          const interFeldPairs = {};

          rows.forEach(row => {
            const fam = row[famIndex];
            const hex = row[hexIndex] === '-' ? 'Missing' : row[hexIndex];
            const allele = row[alleleIndex];
            const feld = row[feldIndex];
            const inter = row[interIndex];

            if (fam) famCounts[fam] = (famCounts[fam] || 0) + 1;
            if (hex) hexCounts[hex] = (hexCounts[hex] || 0) + 1;
            if (allele) alleleCounts[allele] = (alleleCounts[allele] || 0) + 1;
            if (feld && inter) interFeldPairs[inter] = feld;
          });

          const totalSNPs = rows.filter(row => row[feldIndex]).length;
          const percent = Math.round((Object.keys(interFeldPairs).length / totalSNPs) * 100);

          const progressBar = document.getElementById("snpProgress");
          progressBar.style.width = `${percent}%`;
          progressBar.textContent = `${percent}%`;
          document.getElementById("snpTotal").textContent = `${Object.keys(interFeldPairs).length} of ${totalSNPs} records processed`;

          const chartsDiv = document.getElementById("charts");
          chartsDiv.innerHTML =
            createChartSection("famChart", "Distribution of FAM_SNIP") +
            createChartSection("hexChart", "Distribution of HEX_SNIP") +
            createChartSection("alleleChart", "Allele/Locus Count") +
            createChartSection("interFeldChart", "Intermarker_ID vs FelderhoffSNP_ID");

          renderBarChart("famChart", famCounts);
          renderBarChart("hexChart", hexCounts);
          renderBarChart("alleleChart", alleleCounts);

          const interLabels = Object.keys(interFeldPairs);
          const feldLabels = Object.values(interFeldPairs);
          new Chart("interFeldChart", {
            type: 'bar',
            data: {
              labels: interLabels,
              datasets: [{
                label: "FelderhoffSNP_ID",
                data: feldLabels.map(() => 1),
                backgroundColor: 'rgba(153, 102, 255, 0.6)',
              }]
            },
            options: {
              indexAxis: 'y',
              scales: {
                x: {
                  ticks: {
                    autoSkip: false,
                    maxRotation: 90,
                    minRotation: 45
                  }
                }
              }
            }
          });

        });
    });

    function renderBarChart(canvasId, dataObj) {
      const labels = Object.keys(dataObj);
      const values = Object.values(dataObj);
      new Chart(canvasId, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: "Count",
            data: values,
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              ticks: {
                maxRotation: 60,
                minRotation: 45,
                autoSkip: false
              }
            }
          }
        }
      });
    }
  </script>

</body>
</html>
