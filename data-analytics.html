<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Analytics</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    .chart-container {
      position: relative;
      height: 400px;
      margin-bottom: 40px;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 10px;
    }
    .fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: white;
      z-index: 9999;
      padding: 20px;
      overflow: auto;
    }
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chart-header button {
      margin-left: 10px;
    }
    .progress-bar {
      background-color: pink;
    }
    canvas {
      max-width: 100%;
    }
    .rotate-labels {
      white-space: nowrap;
      transform: rotate(-45deg);
      transform-origin: bottom left;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <h2 class="mb-4">Data Analytics Dashboard</h2>

    <!-- Filter Dropdown -->
    <div class="mb-4">
      <label for="snpFilter" class="form-label">Filter by SNP Type:</label>
      <select class="form-select" id="snpFilter">
        <option value="all">All</option>
        <option value="FAM">FAM</option>
        <option value="HEX">HEX</option>
      </select>
    </div>

    <!-- Progress Bar -->
    <div class="mb-4">
      <label class="form-label">FelderhoffSNP_ID Progress:</label>
      <div class="progress">
        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
      </div>
    </div>

    <!-- Chart Containers -->
    <div id="charts">
      <div class="chart-container">
        <div class="chart-header">
          <h5>FAM_SNIP Distribution</h5>
          <div>
            <button class="btn btn-sm btn-secondary" onclick="toggleFullscreen(this)">üîç</button>
          </div>
        </div>
        <canvas id="famChart"></canvas>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <h5>HEX_SNIP Distribution</h5>
          <div>
            <button class="btn btn-sm btn-secondary" onclick="toggleFullscreen(this)">üîç</button>
          </div>
        </div>
        <canvas id="hexChart"></canvas>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <h5>Allele/Locus Count</h5>
          <div>
            <button class="btn btn-sm btn-secondary" onclick="toggleFullscreen(this)">üîç</button>
          </div>
        </div>
        <canvas id="alleleChart"></canvas>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <h5>Intermarker_ID vs FelderhoffSNP_ID</h5>
          <div>
            <button class="btn btn-sm btn-secondary" onclick="toggleFullscreen(this)">üîç</button>
          </div>
        </div>
        <canvas id="mappingChart"></canvas>
      </div>
    </div>

    <!-- Export Buttons -->
    <div class="mt-4">
      <button class="btn btn-outline-primary" onclick="exportChartsAsImage()">Export Charts as PNG</button>
      <button class="btn btn-outline-success" onclick="exportCSV()">Export Data as CSV</button>
    </div>
  </div>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTUQTjArcnYl6cCmCoimL5AI1HrNez2tMvJEGBoAPNYJPFMTdxQwbEWit5iscTMeoHKI3Y9SZjb8uMX/pub?gid=0&single=true&output=csv";

    let originalData = [];

    function fetchData() {
      fetch(csvUrl)
        .then(response => response.text())
        .then(csv => {
          Papa.parse(csv, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
              originalData = results.data;
              updateProgressBar();
              renderCharts("all");
              document.getElementById("snpFilter").addEventListener("change", e => {
                renderCharts(e.target.value);
              });
            }
          });
        });
    }

    function updateProgressBar() {
      const total = originalData.length;
      const percentage = Math.min((total / 10).toFixed(0) * 10, 100);
      const progressBar = document.getElementById("progressBar");
      progressBar.style.width = percentage + "%";
      progressBar.textContent = `${percentage}%`;
    }

    function renderCharts(filter) {
      const data = originalData.filter(row => {
        if (filter === "FAM") return row.FAM_SNIP && row.FAM_SNIP !== "-";
        if (filter === "HEX") return row.HEX_SNIP && row.HEX_SNIP !== "-";
        return true;
      });

      const famCounts = {};
      const hexCounts = {};
      const alleleCounts = {};
      const mappings = [];

      data.forEach(row => {
        const fam = row.FAM_SNIP;
        const hex = row.HEX_SNIP === "-" ? "Missing" : row.HEX_SNIP;
        const allele = row["Allele/Locus"];

        famCounts[fam] = (famCounts[fam] || 0) + 1;
        hexCounts[hex] = (hexCounts[hex] || 0) + 1;
        alleleCounts[allele] = (alleleCounts[allele] || 0) + 1;

        mappings.push({
          intermarker: row.Intermarker_ID,
          felderhoff: row.FelderhoffSNP_ID
        });
      });

      drawBarChart("famChart", famCounts, "FAM_SNIP Distribution");
      drawBarChart("hexChart", hexCounts, "HEX_SNIP Distribution");
      drawBarChart("alleleChart", alleleCounts, "Allele/Locus Count");
      drawHorizontalBar("mappingChart", mappings);
    }

    function drawBarChart(canvasId, data, label) {
      const ctx = document.getElementById(canvasId).getContext("2d");
      if (window[canvasId]) window[canvasId].destroy();
      window[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(data),
          datasets: [{
            label: label,
            data: Object.values(data),
            backgroundColor: '#512888'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { mode: 'index', intersect: false }
          },
          scales: {
            x: {
              ticks: {
                callback: function(val) {
                  return this.getLabelForValue(val).length > 10 ? this.getLabelForValue(val).slice(0, 10) + '‚Ä¶' : this.getLabelForValue(val);
                },
              }
            }
          }
        }
      });
    }

    function drawHorizontalBar(canvasId, data) {
      const ctx = document.getElementById(canvasId).getContext("2d");
      if (window[canvasId]) window[canvasId].destroy();
      window[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(d => d.intermarker),
          datasets: [{
            label: 'FelderhoffSNP_ID',
            data: data.map(d => d.felderhoff),
            backgroundColor: '#8a2be2'
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              ticks: {
                autoSkip: false,
                maxRotation: 0,
                minRotation: 0
              }
            }
          }
        }
      });
    }

    function exportChartsAsImage() {
      document.querySelectorAll("canvas").forEach((canvas, index) => {
        const a = document.createElement("a");
        a.download = `chart-${index + 1}.png`;
        a.href = canvas.toDataURL();
        a.click();
      });
    }

    function exportCSV() {
      const csv = Papa.unparse(originalData);
      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "exported_data.csv";
      a.click();
    }

    function toggleFullscreen(button) {
      const chartContainer = button.closest(".chart-container");
      chartContainer.classList.toggle("fullscreen");
    }

    fetchData();
  </script>
</body>
</html>
